# Proposal v0.2 - 2023-10-05

## Objective
Currently, in the v0.1 of the MFM, we have built a lot of components as a PoC and learning process to build a finance machine that can query and execute operations on chain, and on top of that, managing portfolios of cryptoassets.
It was written without much carefully around the design and implementation details, and now it's getting harder and harder to maintain and evolve the platform.
This Proposal for the v0.2 is focused in a full redesign and refactor that should address the problems mentioned above with a highly flexible and deterministic way to operate states on chain.

## Goals
- Build a state machine library with a state-local storage, that enable us compond states and use it as input of a new state
- The state-local storage needs to be an implementation of the state storage traits
- The state storage traits needs to be based into an commit message process that should enable an non-local storage implementation in the future
- Each state needs to have their handlers for read the input data of the state, and output an componded state for the next state
- Each state handlers needs to operate in a isolate form an behave as determinisc as possible
- States that applies side-effects needs to be tagged as is
- Describe any operation should be a sequence of states with an start input
- The state-local storage needs to carry historically all states data until the operation finish
- Design and implement an report that can read states and report to the user (or to the program like an JSON)

## Components
### State machine
### State storage
### State-local storage
### State report
### Operation

## Example
Those are example that can help us to visualize how that should work.
Everything here is just hipotetically information/data.

### How to get an quoted price between two assets on-chain?
#### By state in order
- read_configuration;
- read_user_flags;
- setup_a_provider; (?)
- get_assets_info;
- get_exchange;
- build_asset_path; (?)
- get_amount_out_for_pair;
- discount_possible_slippage;
- report_to_user;

### How to swap between two assets on-chain?
#### By state in order
- read_configuration;
- read_user_flags;
- setup_a_provider; (?)
- get_assets_info;
- get_exchange;
- build_asset_path; (?)
- get_amount_out_for_pair;
- discount_possible_slippage;
- swap_tokens;
- report_to_user;

### How to report the state of an defined portfolio on-chain?
- read_configuration;
- read_user_flags;
- setup_providers; (?)
- get_assets_info_for_all_networks;
- get_assets_balances_for_all_networks;
- compute_assets_balance_to_quoted_in_token;
- compute_total_balance;
- get_diffs_from_total_balance_and_portfolio_assets_percent;
- get_swap_cost_estimations_for_rebalance_portfolio;
- report_to_user;

